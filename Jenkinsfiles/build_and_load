echo "starting Jenkinsfile build_and_load"

def agent_name = ""

node('ec2') {
  stage "Build"
  agent_name = env.NODE_NAME
  sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/build.sh -O /tmp/build.sh'
  sh 'sudo bash /tmp/build.sh'

  stage "Load"
  sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/load_dry_run.sh -O /tmp/load_dry_run.sh'
  sh 'sudo bash /tmp/load_dry_run.sh'
  
  stage "Train"
  sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/train.sh -O /tmp/train.sh'
  sh 'sudo bash /tmp/train.sh'
}

agent_instance_id = agent_name.find(/i\-[a-z\d]+/)
stage "Save"
node('master') {
    echo "starting save"
    env.agent_instance_id = agent_instance_id
    sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/save.sh -O /tmp/save.sh'
    sh "bash /tmp/save.sh"
    echo "ending save"
}

echo "finishing Jenkinsfile build_and_load"
