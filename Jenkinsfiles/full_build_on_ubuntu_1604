echo "starting full build"

def agent_name = ""


node('worker') {
  
  stage ("Build") {
    agent_name = env.NODE_NAME
    sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/build_on_ubuntu_1604.sh -O /tmp/build.sh'
    sh 'sudo -n bash /tmp/build.sh'
  }

  stage("Load") {
    sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/load.sh -O /tmp/load.sh'
    sh 'sudo -n bash /tmp/load.sh'
  }
  
  stage("Train") {
    sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/train.sh -O /tmp/train.sh'
    sh 'sudo -n bash /tmp/train.sh'
  }
  
}
agent_instance_id = agent_name.find(/i\-[a-z\d]+/)

stage("Save") {

  node('master') {
    withEnv(['agent_instance_id=' + agent_instance_id]) {
      echo "starting save"
      sh 'wget https://raw.githubusercontent.com/FirstDraftGIS/firstdraft/master/bash_scripts/save.sh -O /tmp/save.sh'
      sh "bash /tmp/save.sh"
      echo "ending save"
    }
  }

}

echo "finishing full build"
